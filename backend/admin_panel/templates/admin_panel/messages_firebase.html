{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Messages{% endblock %}
{% block page_title %}Messages{% endblock %}
{% block page_subtitle %}Real-time messaging with Firebase{% endblock %}

{% block extra_css %}
<style>
    * {
        box-sizing: border-box;
    }
    
    .messages-wrapper {
        margin: -24px;
        height: calc(100vh - 120px);
        background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 50%, #e6f0ff 100%);
    }
    
    .messages-container {
        display: flex;
        height: 100%;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* Left Panel - Conversations List */
    .conversations-panel {
        width: 360px;
        min-width: 360px;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        background: #f8fafc;
    }
    
    .conversations-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
    }
    
    .conversations-header-top {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .messenger-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: #1e3a5f;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .messenger-icon svg {
        width: 20px;
        height: 20px;
        color: white;
    }
    
    .conversations-header h2 {
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }
    
    .unread-badge {
        background: #ef4444;
        color: white;
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: auto;
    }
    
    .search-box {
        position: relative;
    }
    
    .search-box input {
        width: 100%;
        padding: 10px 12px 10px 40px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        background: white;
        transition: all 0.2s;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #1e3a5f;
        box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
    }
    
    .search-box svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: #94a3b8;
    }
    
    .conversations-list {
        flex: 1;
        overflow-y: auto;
    }
    
    .conversation-item {
        padding: 14px 20px;
        cursor: pointer;
        transition: background 0.15s;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .conversation-item:hover {
        background: #f1f5f9;
    }
    
    .conversation-item.active {
        background: #e0f2fe;
        border-left: 3px solid #1e3a5f;
    }
    
    .conversation-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(30, 58, 95, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 18px;
        flex-shrink: 0;
    }
    
    .conversation-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .conversation-info {
        flex: 1;
        min-width: 0;
    }
    
    .conversation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    
    .conversation-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 15px;
    }
    
    .conversation-time {
        font-size: 12px;
        color: #94a3b8;
    }
    
    .conversation-preview {
        font-size: 13px;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .conversation-unread {
        background: #ef4444;
        color: white;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 10px;
        flex-shrink: 0;
    }
    
    /* Right Panel - Chat Area */
    .chat-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        min-width: 0;
    }
    
    .chat-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
        background: white;
    }
    
    .chat-header-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(30, 58, 95, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
    }
    
    .chat-header-info {
        flex: 1;
    }
    
    .chat-header-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .verified-badge {
        color: #3b82f6;
    }
    
    .chat-header-status {
        font-size: 13px;
        color: #64748b;
    }
    
    .online-indicator {
        color: #22c55e;
    }
    
    /* Messages Area */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .message-row {
        display: flex;
        padding: 0 16px;
    }
    
    .message-row.sent {
        justify-content: flex-end;
    }
    
    .message-row.received {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 16px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message-row.sent .message-bubble {
        background: #3b82f6;
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message-row.received .message-bubble {
        background: white;
        color: #1e293b;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .message-text {
        font-size: 14px;
        line-height: 1.5;
    }
    
    .message-time {
        font-size: 11px;
        opacity: 0.7;
        text-align: right;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
    }
    
    .message-row.received .message-time {
        color: #94a3b8;
    }
    
    /* Message wrapper for timestamp outside bubble */
    .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 70%;
    }
    
    .message-row.sent .message-wrapper {
        align-items: flex-end;
        margin-left: 60px;
        margin-right: 8px;
    }
    
    .message-row.received .message-wrapper {
        align-items: flex-start;
        margin-right: 60px;
        margin-left: 8px;
    }
    
    .message-time-outside {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #94a3b8;
        margin-top: 4px;
        padding: 0 4px;
    }
    
    .message-row.sent .message-time-outside {
        justify-content: flex-end;
    }
    
    .message-row.received .message-time-outside {
        justify-content: flex-start;
    }
    
    .message-row.sent .message-time-outside svg {
        color: #3b82f6;
    }
    
    /* Message Input */
    .chat-input-container {
        padding: 16px 20px;
        border-top: 1px solid #e5e7eb;
        background: white;
    }
    
    .chat-input-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .file-upload-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .file-upload-btn:hover {
        background: #e2e8f0;
    }
    
    .file-upload-btn svg {
        width: 20px;
        height: 20px;
        color: #64748b;
    }
    
    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 24px;
        font-size: 14px;
        resize: none;
        min-height: 44px;
        max-height: 120px;
        background: #f8fafc;
        transition: all 0.2s;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: #1e3a5f;
        background: white;
    }
    
    .send-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #1e3a5f;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .send-btn:hover {
        background: #2d4a6f;
    }
    
    .send-btn:disabled {
        background: #94a3b8;
        cursor: not-allowed;
    }
    
    .send-btn svg {
        width: 20px;
        height: 20px;
        color: white;
    }
    
    /* File Preview */
    .file-preview-container {
        display: flex;
        gap: 8px;
        padding: 8px 0;
        flex-wrap: wrap;
    }
    
    .file-preview-item {
        position: relative;
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }
    
    .file-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .file-preview-remove {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 20px;
        height: 20px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    
    /* Message Attachments */
    .message-attachment {
        margin-top: 8px;
        max-width: 250px;
    }
    
    .message-attachment img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .message-attachment video {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
    }
    
    /* Image Preview Modal */
    .image-preview-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    .image-preview-modal img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
    }
    
    .image-preview-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.1);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Empty State */
    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        color: #64748b;
    }
    
    .empty-state-icon {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
    }
    
    .empty-state-icon svg {
        width: 60px;
        height: 60px;
        color: #94a3b8;
    }
    
    .empty-state h3 {
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 8px 0;
    }
    
    .empty-state p {
        font-size: 14px;
        color: #64748b;
        margin: 0;
    }
    
    /* Loading State */
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e2e8f0;
        border-top-color: #1e3a5f;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Date Separator */
    .date-separator {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px 0;
    }
    
    .date-separator span {
        background: #e2e8f0;
        color: #64748b;
        font-size: 12px;
        padding: 4px 12px;
        border-radius: 12px;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .messages-wrapper {
            margin: -16px;
            height: calc(100vh - 80px);
        }
        
        .messages-container {
            flex-direction: column;
        }
        
        .conversations-panel {
            width: 100%;
            min-width: 100%;
            height: 100%;
            border-right: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        
        .conversations-panel.hidden {
            transform: translateX(-100%);
        }
        
        .chat-panel {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .chat-header {
            padding: 12px 16px;
        }
        
        .back-button {
            display: flex !important;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .back-button:hover {
            background: #e2e8f0;
        }
        
        .chat-messages {
            padding: 16px;
        }
        
        .message-row {
            padding: 0 8px;
        }
        
        .message-bubble {
            max-width: 85%;
        }
        
        .message-row.sent .message-wrapper {
            margin-left: 40px;
            margin-right: 8px;
        }
        
        .message-row.received .message-wrapper {
            margin-right: 40px;
            margin-left: 8px;
        }
        
        .chat-input-container {
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));
        }
        
        .file-upload-btn,
        .send-btn {
            width: 40px;
            height: 40px;
        }
        
        .chat-input {
            padding: 10px 14px;
            min-height: 40px;
        }
    }
    
    /* Tablet */
    @media (min-width: 769px) and (max-width: 1024px) {
        .conversations-panel {
            width: 300px;
            min-width: 300px;
        }
        
        .message-bubble {
            max-width: 75%;
        }
    }
    
    /* Back button hidden on desktop */
    .back-button {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="messages-wrapper">
    <div class="messages-container">
        <!-- Conversations Panel -->
        <div class="conversations-panel">
            <div class="conversations-header">
                <div class="conversations-header-top">
                    <div class="messenger-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                    </div>
                    <h2>Messenger</h2>
                    <span class="unread-badge" id="totalUnread" style="display: none;">0</span>
                </div>
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search conversations...">
                </div>
            </div>
            <div class="conversations-list" id="conversationsList">
                <div style="display: flex; justify-content: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Chat Panel -->
        <div class="chat-panel" id="chatPanel">
            <div class="empty-state" id="emptyState">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                <h3>Select a conversation</h3>
                <p>Choose a conversation from the sidebar to start chatting</p>
            </div>
            
            <div id="chatArea" style="display: none; flex-direction: column; height: 100%;">
                <div class="chat-header" id="chatHeader"></div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <div class="file-preview-container" id="filePreviewContainer" style="display: none;"></div>
                    <div class="chat-input-wrapper">
                        <input type="file" id="fileInput" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
                        <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                            </svg>
                        </button>
                        <textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m22 2-7 20-4-9-9-4z"/>
                                <path d="M22 2 11 13"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="image-preview-modal" id="imagePreviewModal" style="display: none;" onclick="closeImagePreview()">
    <button class="image-preview-close" onclick="closeImagePreview()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path d="M18 6 6 18M6 6l12 12"/>
        </svg>
    </button>
    <img id="previewImage" src="" alt="Preview">
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, addDoc, query, where, orderBy, onSnapshot, updateDoc, serverTimestamp, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDhzXlStDkh7tdWNyw_pFkhmoIqCRJq06g",
        authDomain: "recruiter-message.firebaseapp.com",
        projectId: "recruiter-message",
        storageBucket: "recruiter-message.firebasestorage.app",
        messagingSenderId: "274352254612",
        appId: "1:274352254612:web:3cf8700a6f605b8ec3ce81"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Current admin user
    const currentUser = {
        id: {{ request.user.id }},
        name: "{{ request.user.get_full_name|default:request.user.username }}",
        email: "{{ request.user.email }}",
        role: "admin",
        position: "Recruiter",
        companyName: "Talent Horizon",
        companyAddress: "New York, NY",
        isVerified: true
    };
    
    // State
    let conversations = [];
    let currentConversation = null;
    let messagesUnsubscribe = null;
    let selectedFiles = [];
    
    // Subscribe to conversations
    function subscribeToConversations() {
        const q = query(
            collection(db, 'conversations'),
            where('participantIds', 'array-contains', currentUser.id)
        );
        
        onSnapshot(q, (snapshot) => {
            conversations = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // Sort by updatedAt
            conversations.sort((a, b) => {
                const timeA = a.updatedAt?.toMillis?.() || 0;
                const timeB = b.updatedAt?.toMillis?.() || 0;
                return timeB - timeA;
            });
            
            renderConversations();
            updateTotalUnread();
        });
    }
    
    // Render conversations list
    function renderConversations() {
        const container = document.getElementById('conversationsList');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        const filtered = conversations.filter(conv => {
            const otherParticipant = conv.participants?.find(p => p.id !== currentUser.id);
            return otherParticipant?.name?.toLowerCase().includes(searchTerm) || 
                   conv.lastMessage?.toLowerCase().includes(searchTerm);
        });
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <p>No conversations found</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filtered.map(conv => {
            const otherParticipant = conv.participants?.find(p => p.id !== currentUser.id);
            const unreadCount = conv.unreadCount?.[currentUser.id] || 0;
            const isActive = currentConversation?.id === conv.id;
            const time = conv.lastMessageTime?.toDate?.() || new Date();
            const timeStr = formatTime(time);
            const initials = otherParticipant?.name?.split(' ').map(n => n[0]).join('').toUpperCase() || '?';
            
            return `
                <div class="conversation-item ${isActive ? 'active' : ''}" onclick="selectConversation('${conv.id}')">
                    <div class="conversation-avatar">${initials}</div>
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <span class="conversation-name">${otherParticipant?.name || 'Unknown'}</span>
                            <span class="conversation-time">${timeStr}</span>
                        </div>
                        <div class="conversation-preview">
                            <span>${conv.lastMessage || 'No messages yet'}</span>
                            ${unreadCount > 0 ? `<span class="conversation-unread">${unreadCount}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Select conversation
    window.selectConversation = async function(convId) {
        currentConversation = conversations.find(c => c.id === convId);
        if (!currentConversation) return;
        
        // Update UI
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('chatArea').style.display = 'flex';
        
        // Render header
        const otherParticipant = currentConversation.participants?.find(p => p.id !== currentUser.id);
        const initials = otherParticipant?.name?.split(' ').map(n => n[0]).join('').toUpperCase() || '?';
        
        document.getElementById('chatHeader').innerHTML = `
            <button class="back-button" onclick="goBackToConversations()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            </button>
            <div class="chat-header-avatar">${initials}</div>
            <div class="chat-header-info">
                <div class="chat-header-name">
                    ${otherParticipant?.name || 'Unknown'}
                </div>
                <div class="chat-header-status">
                    <span class="online-indicator">●</span> Online
                </div>
            </div>
        `;
        
        // Hide conversations panel on mobile
        if (window.innerWidth <= 768) {
            document.querySelector('.conversations-panel').classList.add('hidden');
        }
        
        // Subscribe to messages
        if (messagesUnsubscribe) messagesUnsubscribe();
        
        const q = query(
            collection(db, 'messages'),
            where('conversationId', '==', convId)
        );
        
        messagesUnsubscribe = onSnapshot(q, (snapshot) => {
            let messages = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // Sort by timestamp
            messages.sort((a, b) => {
                const timeA = a.timestamp?.toMillis?.() || 0;
                const timeB = b.timestamp?.toMillis?.() || 0;
                return timeA - timeB;
            });
            
            renderMessages(messages);
        });
        
        // Mark as read
        await markAsRead(convId);
        
        // Re-render conversations to update active state
        renderConversations();
    };
    
    // Render messages
    function renderMessages(messages) {
        const container = document.getElementById('chatMessages');
        
        if (messages.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <p>No messages yet. Start the conversation!</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        let lastDate = null;
        
        messages.forEach(msg => {
            const isSent = msg.senderId === currentUser.id;
            const time = msg.timestamp?.toDate?.() || new Date();
            const dateStr = time.toLocaleDateString();
            
            // Add date separator if new day
            if (dateStr !== lastDate) {
                html += `
                    <div class="date-separator">
                        <span>${formatDate(time)}</span>
                    </div>
                `;
                lastDate = dateStr;
            }
            
            html += `
                <div class="message-row ${isSent ? 'sent' : 'received'}">
                    <div class="message-wrapper">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                            ${msg.attachments?.length ? renderAttachments(msg.attachments) : ''}
                        </div>
                        <div class="message-time-outside">
                            ${formatBubbleTime(time)}
                            ${isSent ? `
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    ${msg.isRead ? '<path d="M18 6 7 17l-5-5"/><path d="m22 10-9.5 9.5-3-3"/>' : '<path d="M20 6 9 17l-5-5"/>'}
                                </svg>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
    }
    
    // Render attachments
    function renderAttachments(attachments) {
        return attachments.map(url => {
            const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
            const isVideo = /\.(mp4|webm|ogg)$/i.test(url);
            
            if (isImage) {
                return `
                    <div class="message-attachment">
                        <img src="${url}" alt="Image" onclick="openImagePreview('${url}')">
                    </div>
                `;
            } else if (isVideo) {
                return `
                    <div class="message-attachment">
                        <video src="${url}" controls></video>
                    </div>
                `;
            } else {
                return `
                    <div class="message-attachment">
                        <a href="${url}" target="_blank" class="message-attachment-file">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            Download File
                        </a>
                    </div>
                `;
            }
        }).join('');
    }
    
    // Send message
    window.sendMessage = async function() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        
        if (!text && selectedFiles.length === 0) return;
        if (!currentConversation) return;
        
        const otherParticipant = currentConversation.participants?.find(p => p.id !== currentUser.id);
        if (!otherParticipant) return;
        
        // Disable send button
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        
        try {
            // Upload files if any (placeholder - would need actual file upload implementation)
            const attachmentUrls = [];
            
            // Create message
            const message = {
                conversationId: currentConversation.id,
                senderId: currentUser.id,
                senderName: currentUser.name,
                senderEmail: currentUser.email,
                senderRole: currentUser.role,
                recipientId: otherParticipant.id,
                recipientName: otherParticipant.name,
                recipientEmail: otherParticipant.email,
                content: text,
                timestamp: serverTimestamp(),
                isRead: false,
                attachments: attachmentUrls
            };
            
            await addDoc(collection(db, 'messages'), message);
            
            // Update conversation
            await updateDoc(doc(db, 'conversations', currentConversation.id), {
                lastMessage: text,
                lastMessageTime: serverTimestamp(),
                lastSenderId: currentUser.id,
                updatedAt: serverTimestamp()
            });
            
            // Clear input
            input.value = '';
            selectedFiles = [];
            document.getElementById('filePreviewContainer').style.display = 'none';
            document.getElementById('filePreviewContainer').innerHTML = '';
            
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message. Please try again.');
        } finally {
            sendBtn.disabled = false;
        }
    };
    
    // Mark messages as read
    async function markAsRead(convId) {
        const q = query(
            collection(db, 'messages'),
            where('conversationId', '==', convId),
            where('recipientId', '==', currentUser.id),
            where('isRead', '==', false)
        );
        
        const snapshot = await getDocs(q);
        const updates = snapshot.docs.map(docSnap => 
            updateDoc(doc(db, 'messages', docSnap.id), { isRead: true })
        );
        
        await Promise.all(updates);
        
        // Reset unread count
        await updateDoc(doc(db, 'conversations', convId), {
            [`unreadCount.${currentUser.id}`]: 0
        });
    }
    
    // Update total unread badge
    function updateTotalUnread() {
        const total = conversations.reduce((sum, conv) => {
            return sum + (conv.unreadCount?.[currentUser.id] || 0);
        }, 0);
        
        const badge = document.getElementById('totalUnread');
        if (total > 0) {
            badge.textContent = total;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
    
    // Image preview
    window.openImagePreview = function(url) {
        document.getElementById('previewImage').src = url;
        document.getElementById('imagePreviewModal').style.display = 'flex';
    };
    
    window.closeImagePreview = function() {
        document.getElementById('imagePreviewModal').style.display = 'none';
    };
    
    // Go back to conversations list (mobile)
    window.goBackToConversations = function() {
        document.querySelector('.conversations-panel').classList.remove('hidden');
        currentConversation = null;
        renderConversations();
    };
    
    // Helper functions
    function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        
        if (days === 0) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        } else if (days === 1) {
            return 'Yesterday';
        } else if (days < 7) {
            return date.toLocaleDateString('en-US', { weekday: 'short' });
        } else {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
    }
    
    function formatDate(date) {
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        
        if (days === 0) return 'Today';
        if (days === 1) return 'Yesterday';
        return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    }
    
    function formatBubbleTime(date) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Event listeners
    document.getElementById('searchInput').addEventListener('input', renderConversations);
    
    document.getElementById('messageInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // File input handler
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        selectedFiles = [...selectedFiles, ...files];
        renderFilePreview();
    });
    
    function renderFilePreview() {
        const container = document.getElementById('filePreviewContainer');
        if (selectedFiles.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        container.innerHTML = selectedFiles.map((file, index) => {
            const isImage = file.type.startsWith('image/');
            return `
                <div class="file-preview-item">
                    ${isImage ? `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` : `
                        <div style="width: 100%; height: 100%; background: #e2e8f0; display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                    `}
                    <button class="file-preview-remove" onclick="removeFile(${index})">×</button>
                </div>
            `;
        }).join('');
    }
    
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        renderFilePreview();
    };
    
    // Initialize
    subscribeToConversations();
</script>
{% endblock %}
